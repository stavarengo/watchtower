name: Release (Production)

on:
  workflow_dispatch: {}
  # push:
  #   tags:
  #     - 'v[0-9]+.[0-9]+.[0-9]+'
  #     - '**/v[0-9]+.[0-9]+.[0-9]+'
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # lint:
  #   name: Lint
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - name: Set up Go
  #       uses: actions/setup-go@v4
  #       with:
  #         go-version: 1.20.x
  #     - uses: dominikh/staticcheck-action@ba605356b4b29a60e87ab9404b712f3461e566dc #v1.3.0
  #       with:
  #         version: "2022.1.1"
  #         install-go: "false" # StaticCheck uses go v1.17 which does not support `any`

  # test:
  #   name: Test
  #   strategy:
  #     matrix:
  #       go-version:
  #         - 1.20.x
  #       platform:
  #         - ubuntu-latest
  #         - macos-latest
  #         - windows-latest
  #   runs-on: ${{ matrix.platform }}
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - name: Set up Go
  #       uses: actions/setup-go@v4
  #       with:
  #         go-version: 1.20.x
  #     - name: Run tests
  #       run: |
  #         go test ./... -coverprofile coverage.out

  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents:  write
      packages: write
    # needs: 
    #   - test
    #   - lint
    env:
      CGO_ENABLED: 0
      TAG: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version tags
        id: version
        run: |
          # Get current date and time in UTC
          YEAR=$(date -u +%Y)
          MONTH=$(date -u +%m)
          DAY=$(date -u +%d)
          TIME=$(date -u +%H%M)
          
          # Create the version tags
          MAIN_TAG="v${YEAR}.${MONTH}.${DAY}-build.${TIME}"
          DAY_TAG="v${YEAR}.${MONTH}.${DAY}"
          MONTH_TAG="v${YEAR}.${MONTH}"
          YEAR_TAG="v${YEAR}"
          
          echo "main_tag=${MAIN_TAG}" >> $GITHUB_OUTPUT
          echo "day_tag=${DAY_TAG}" >> $GITHUB_OUTPUT
          echo "month_tag=${MONTH_TAG}" >> $GITHUB_OUTPUT
          echo "year_tag=${YEAR_TAG}" >> $GITHUB_OUTPUT
          
          # Create Docker tags
          DOCKER_TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MAIN_TAG}"
          DOCKER_TAGS="${DOCKER_TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${DAY_TAG}"
          DOCKER_TAGS="${DOCKER_TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MONTH_TAG}"
          DOCKER_TAGS="${DOCKER_TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${YEAR_TAG}"
          DOCKER_TAGS="${DOCKER_TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "docker_tags=${DOCKER_TAGS}" >> $GITHUB_OUTPUT


      - name: Create Git commit and tags
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create an empty commit to mark the build
          git commit --allow-empty -m "Automated build: ${{ steps.version.outputs.main_tag }}"
          
          # Create and push tags (force to update existing tags like latest, vYear, etc.)
          git tag -f "${{ steps.version.outputs.main_tag }}"
          # git tag -f "${{ steps.version.outputs.day_tag }}"
          # git tag -f "${{ steps.version.outputs.month_tag }}"
          # git tag -f "${{ steps.version.outputs.year_tag }}"
          # git tag -f "latest"
          
          # Push the commit and tags
          git push origin HEAD
          git push origin --tags --force


      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.20.x
      # - name: Login to Docker Hub
      #   uses: docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc #v2
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build
        uses: goreleaser/goreleaser-action@7ec5c2b0c6cdda6e8bbb49444bc797dd33d74dd8 #v3
        with:
          version: v0.155.0
          args: --debug
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Enable experimental docker features
        run: |
          mkdir -p ~/.docker/ && \
          echo '{"experimental": "enabled"}' > ~/.docker/config.json
      - name: Create and annotate manifests
        run: |
          # Create and annotate manifest for main_tag (vYear.Month.Day-build.HHmm)
          docker manifest create \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.main_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }}
          docker manifest annotate \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.main_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }} \
            --os linux --arch amd64
          
          # Create rolling tag manifests (day, month, year) that all reference the same timestamped image
          # This creates multiple tags pointing to the same build for easy version selection
          
          # Create and annotate manifest for day_tag (vYear.Month.Day)
          docker manifest create \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.day_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }}
          docker manifest annotate \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.day_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }} \
            --os linux --arch amd64
          
          # Create and annotate manifest for month_tag (vYear.Month)
          docker manifest create \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.month_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }}
          docker manifest annotate \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.month_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }} \
            --os linux --arch amd64
          
          # Create and annotate manifest for year_tag (vYear)
          docker manifest create \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.year_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }}
          docker manifest annotate \
            ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.year_tag }} \
            ghcr.io/stavarengo/watchtower:amd64-${{ steps.version.outputs.main_tag }} \
            --os linux --arch amd64
          
          # Create and annotate manifest for latest (references amd64-latest built by goreleaser)
          docker manifest create \
            ghcr.io/stavarengo/watchtower:latest \
            ghcr.io/stavarengo/watchtower:amd64-latest
          docker manifest annotate \
            ghcr.io/stavarengo/watchtower:latest \
            ghcr.io/stavarengo/watchtower:amd64-latest \
            --os linux --arch amd64
      # - name: Annotate manifest for latest
      #   run: |
      #     for REPO in '' ghcr.io/ ; do

      #     docker manifest annotate \
      #       ${REPO}containrrr/watchtower:latest \
      #       ${REPO}containrrr/watchtower:i386-latest \
      #       --os linux \
      #       --arch 386
      
      #     docker manifest annotate \
      #       ${REPO}containrrr/watchtower:latest \
      #       ${REPO}containrrr/watchtower:armhf-latest \
      #       --os linux \
      #       --arch arm
            
      #     docker manifest annotate \
      #       ${REPO}containrrr/watchtower:latest \
      #       ${REPO}containrrr/watchtower:arm64v8-latest \
      #       --os linux \
      #       --arch arm64 \
      #       --variant v8

      #     done
      # - name: Push manifests to Dockerhub
      #   env:
      #     DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      #     DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      #   run: |
      #     docker login -u $DOCKER_USER -p $DOCKER_TOKEN && \
      #       docker manifest push containrrr/watchtower:$(echo $TAG | sed 's/^v*//') && \
      #       docker manifest push containrrr/watchtower:latest
      # - name: Push manifests to GitHub Container Registry
      #   env:
      #     DOCKER_USER: ${{ github.actor }}
      #     DOCKER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     REGISTRY:  ${{ env.REGISTRY }}
      #   run: |
      #     docker login -u $DOCKER_USER -p $DOCKER_TOKEN $REGISTRY && \
      #       docker manifest push ghcr.io/containrrr/watchtower:$(echo $TAG | sed 's/^v*//') && \
      #       docker manifest push ghcr.io/containrrr/watchtower:latest 
      - name: Push manifests to GitHub Container Registry
        env:
          DOCKER_USER: ${{ github.actor }}
          DOCKER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGISTRY:  ${{ env.REGISTRY }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_TOKEN $REGISTRY && \
            docker manifest push ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.main_tag }} && \
            docker manifest push ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.day_tag }} && \
            docker manifest push ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.month_tag }} && \
            docker manifest push ghcr.io/stavarengo/watchtower:${{ steps.version.outputs.year_tag }} && \
            docker manifest push ghcr.io/stavarengo/watchtower:latest


  # renew-docs:
  #   name: Refresh pkg.go.dev
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Pull new module version
  #     uses: andrewslotin/go-proxy-pull-action@50fea06a976087614babb9508e5c528b464f4645 #master@2022-10-14

  
  

  
